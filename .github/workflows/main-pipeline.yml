name: Production Pipeline 2026

on:
  push:
    branches: [ main ]

jobs:
  # 1. Fase de Calidad (CI)
  test-and-verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Run Tests (Unit & Integration)
        run: mvn clean test

  # 2. Fase de Empaquetado (Docker)
  build-and-push:
    needs: test-and-verify
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Usamos el SHA del commit como tag para trazabilidad (Best Practice 2026)
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/prices-service:latest
            ${{ secrets.DOCKER_USERNAME }}/prices-service:${{ github.sha }}

  # 3. Fase de Despliegue (CD)
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure Kubernetes set context
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Deploy to Kubernetes
        run: |
          # Aplicamos los manifiestos (Deployment, Service, etc.)
          kubectl apply -f k8s/deployment.yml -n ecommerce
          
          # Forzamos la actualizaci√≥n con la nueva imagen generada
          kubectl set image deployment/prices-service prices-service=${{ secrets.DOCKER_USERNAME }}/prices-service:${{ github.sha }} -n ecommerce
          
          # Verificamos que el despliegue sea exitoso
          kubectl rollout status deployment/prices-service -n ecommerce